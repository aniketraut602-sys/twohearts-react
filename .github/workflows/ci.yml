name: CI - 7 Iterative Validations

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  iterative-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Iterative validations (7 runs)
        run: |
          set -e
          for i in {1..7}; do
            echo "=== ITERATION $i ==="
            # Install dependencies (CI will have network)
            npm ci
            echo "Running lint (iteration $i)"
            npm run lint --if-present || true
            echo "Running unit tests (iteration $i)"
            npm test --if-present || true
            echo "Build (iteration $i)"
            npm run build
            echo "Running accessibility checks (iteration $i)"
            # Optional: axe or pa11y if configured
            if [ -f package.json ]; then
              if npm run --silent | grep -q "a11y"; then
                npm run a11y || true
              fi
            fi
            echo "Running bundle analysis (iteration $i)"
            if npm run --silent | grep -q "analyze"; then
              npm run analyze || true
            fi
            echo "Iteration $i completed"
          done
      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist || build || .
